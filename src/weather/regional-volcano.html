<!DOCTYPE html>
<html lang="en" class="h-100">
  <head>
    <title>Regional Volcano</title>
    @@include('../partials/head.html')
  </head>
  <body class="d-flex flex-column h-100">
    @@include('../partials/header.html')
    <main>
      <section aria-label="main content">
        <div class="container">
          <h1>Regional Volcano</h1>
          <p>The data shown is a snapshot from 8 March 2023</p>
          <p><a href="https://www.nea.gov.sg/weather/regional-volcanic-eruptions" target="_blank">Live Widget Location</a></p>
          
          <div class="bg-white p-3">
            <div class="row">
              <div class="col-12 col-md-7">
                <div class="map-div" id="regional-volcano" style="position: relative; width: 500px; height:600px"></div>
                <button class="btn btn--solid-green zoom-button" data-zoom="reset" onclick="return false">Reset</button>
                <button class="btn btn--solid-green zoom-button" data-zoom="out" onclick="return false">-</button>
                <button class="btn btn--solid-green zoom-button" data-zoom="in" onclick="return false">+</button>
              </div>
              <div class="col-12 col-md-5">
                <div class="regional-info" id="regional-info"></div>
              </div>
            </div>
          </div>
        
        </div>
      </section>
    </main>
    @@include('../partials/footer.html')
    @@include('../partials/scripts.html')
    <script src="/js/d3.min.js" type="text/javascript"></script>
    <script src="/js/topojson.min.js" type="text/javascript"></script>
    <script src="/js/datamaps.min.js" type="text/javascript"></script>
    <script>

      // building table and syncing data with map
      function tableBuilder(datas) {
        if(datas) {
          let infoHeader = $('<div class="regional-info-row regional-info-header"><span>Volcano</span><span>Date of Last Eruption</span></div>');
          $('.regional-info').append(infoHeader);

          for(var i = 0; i < datas.length; i++) {
            let data = datas[i];
            let infoPanel = $('<div class="regional-info-panel" data-index="' + i + '"></div>');
            
            let infoRow = $('<div class="regional-info-row" data-bs-toggle="collapse" data-bs-target="#' + data.NameOfVolcano + '" aria-expanded="false" aria-controls="' + data.NameOfVolcano + '"></div>');
            infoRow.append('<span>'+ data.NameOfVolcano + '</span>');
            infoRow.append('<span>'+ data.DisplayDate + '</span>');
            infoRow.append('<span class="collapse-toggle"></span>');
            infoPanel.append(infoRow);            

            let infoCollapse = $('<div class="collapse" id="' + data.NameOfVolcano + '" data-index="' + i + '" data-bs-parent="#regional-info"></div>');
            let infoTable = $('<table class="table regional-table"></table>');
            let infoTableBody = $('<tbody></tbody>');
            infoTableBody.append('<tr><th>Name of Volcano</th><td>' + data.NameOfVolcano + '</td></tr>')
            infoTableBody.append('<tr><th>Coordinates</th><td>' + data.Coordinates + '</td></tr>')
            infoTableBody.append('<tr><th>Date of last eruption</th><td>' + data.DateOfLastEruption + '</td></tr>')
            infoTableBody.append('<tr><th>Time of eruption</th><td>' + data.TimeOfEruption + '</td></tr>')
            infoTableBody.append('<tr><th>Location</th><td>' + data.Location + '</td></tr>')
            infoTable.append(infoTableBody);
            infoCollapse.append(infoTable);
            infoPanel.append(infoCollapse);

            $('.regional-info').append(infoPanel);
          }
          $('.collapse').on('show.bs.collapse', function(e) {
            let seq = $(e.target).data('index');
            $('.datamaps-bubble').removeClass('active');
            $('.datamaps-bubble:nth-child('+(seq+1)+')').addClass('active');
          });
        } else {
          let content = $('<div class="no-regional-warning"><p>There is no volcanic eruption in the region.</p></div>');
          $('.regional-info').append(content);
        }
      }

      function initMap(hasData, volcanoes) {
        if(hasData) {
          tableBuilder(volcanoes);
        } else {
          tableBuilder();
        }
        $('text:contains("Brunei")').attr('y', '263');
        $('text:contains("Japan")').attr('y', '103');
        $('text:contains("Taiwan")').attr('y', '170');
        $('text:contains("Laos")').attr('y', '192');
        $('text:contains("Myanmar")').attr('y', '180');
        $('text:contains("Vietnam")').attr('y', '205');
      }

      function HandleBubbleClick(bubble) {
        let seq = bubble.Sequence;
        $('.regional-info-panel[data-index=' + seq + ']').find('.regional-info-row').click();
      }

      // map zooming
      function Zoom(args) {
        $.extend(this, {
          $buttons: $('.zoom-button'),
          scale: { max: 50, currentShift: 0 },
          $container: args.$container,
          datamap: args.datamap
        });
        this.init();
      }

      // map related
      let center = [135, -3];
      let scale = 280;
      var map = new Datamaps({
        scope: 'world',
        element: $('#regional-volcano').get(0),
        setProjection: function(elem) {
          var projection = d3.geo.equirectangular()
            .center(center)
            .scale(scale)
            .translate([elem.offsetWidth / 2, elem.offsetHeight / 2]);
          var path = d3.geo.path().projection(projection);
          return {
            path: path,
            projection: projection
          }
        },
        geographyConfig: {
          dataUrl: null,
          hideAntarctica: true,
          borderWidth: 1,
          borderOpacity: 1,
          borderColor: '#fdfdfd',
          popupOnHover: false,
          highlightOnHover: false,
          highlightFillColor: '#3250a8',
          highlightBorderColor: 'rgba(250, 15, 160, 0.2)',
          highlightBorderWidth: 2,
          highlightBorderOpacity: 1
        },
        fills: {
          defaultFill: "#c9c9c9",
          pnt: "#000000"
        }, 
        done: function(e) {
          // done
        }
      })

      $.getJSON('/data/active-volcano.json', function(volcanoes) {
        volcanoes.map(function(volcano) {
          volcano.longitude = volcano.Lon,
          volcano.latitude = volcano.Lat,
          volcano.radius = 8,
          volcano.fillKey = 'pnt'
        });
        map.bubbles(volcanoes, {
          borderWidth: 1,
          popupOnHover: false,
          highlightOnHover: false
        });
        d3.selectAll('.datamaps-bubble').style('fill', function(volcano) {
          return volcano.IsEruptive ? 'red' : 'purple';
        });
        d3.selectAll('.datamaps-bubble').on('click', function(volcano) {
          let isActive = d3.select(this).classed('active');
          d3.selectAll('.datamaps-bubble').classed('active', false);
          d3.select(this).classed('active', !isActive);
          window.HandleBubbleClick(volcano);
        });
        if(volcanoes && volcanoes.length) {
          initMap(true, volcanoes);
        } else {
          initMap(false, null);
        }
      });

      map.labels({
        customLabelText: {
          AFG: " ",
          ALA: " ",
          ALB: " ",
          DZA: " ",
          ASM: " ",
          AND: " ",
          AGO: " ",
          AIA: " ",
          ATA: " ",
          ATG: " ",
          ARG: " ",
          ARM: " ",
          ABW: " ",
          AUS: "Australia",
          AUT: " ",
          AZE: " ",
          BHS: " ",
          BHR: " ",
          BGD: " ",
          BRB: " ",
          BLR: " ",
          BEL: " ",
          BLZ: " ",
          BEN: " ",
          BMU: " ",
          BTN: " ",
          BOL: " ",
          BES: " ",
          BIH: " ",
          BWA: " ",
          BVT: " ",
          BRA: " ",
          IOT: " ",
          VGB: " ",
          BRN: "Brunei",
          BGR: " ",
          BFA: " ",
          BDI: " ",
          KHM: "Cambodia",
          CMR: " ",
          CAN: " ",
          CPV: " ",
          CYM: " ",
          CAF: " ",
          TCD: " ",
          CHL: " ",
          CHN: "China",
          CXR: " ",
          CCK: " ",
          COL: " ",
          COM: " ",
          COK: " ",
          CRI: " ",
          HRV: " ",
          CUB: " ",
          CUW: " ",
          CYP: " ",
          CZE: " ",
          COD: " ",
          DNK: " ",
          DJI: " ",
          DMA: " ",
          DOM: " ",
          TLS: " ",
          ECU: " ",
          EGY: " ",
          SLV: " ",
          GNQ: " ",
          ERI: " ",
          EST: " ",
          ETH: " ",
          FLK: " ",
          FRO: " ",
          FJI: " ",
          FIN: " ",
          FRA: " ",
          GUF: " ",
          PYF: " ",
          ATF: " ",
          GAB: " ",
          GMB: " ",
          GEO: " ",
          DEU: " ",
          GHA: " ",
          GIB: " ",
          GRC: " ",
          GRL: " ",
          GRD: " ",
          GLP: " ",
          GUM: " ",
          GTM: " ",
          GGY: " ",
          GIN: " ",
          GNB: " ",
          GUY: " ",
          HTI: " ",
          HMD: " ",
          HND: " ",
          HKG: "Hong Kong",
          HUN: " ",
          ISL: " ",
          IND: " ",
          IDN: "Indonesia",
          IRN: " ",
          IRQ: " ",
          IRL: " ",
          IMN: " ",
          ISR: " ",
          ITA: " ",
          CIV: " ",
          JAM: " ",
          JPN: "Japan",
          JEY: " ",
          JOR: " ",
          KAZ: " ",
          KEN: " ",
          KIR: " ",
          XKX: " ",
          KWT: " ",
          KGZ: " ",
          LAO: "Laos",
          LVA: " ",
          LBN: " ",
          LSO: " ",
          LBR: " ",
          LBY: " ",
          LIE: " ",
          LTU: " ",
          LUX: " ",
          MAC: " ",
          MKD: " ",
          MDG: " ",
          MWI: " ",
          MYS: "Malaysia",
          MDV: " ",
          MLI: " ",
          MLT: " ",
          MHL: " ",
          MTQ: " ",
          MRT: " ",
          MUS: " ",
          MYT: " ",
          MEX: " ",
          FSM: " ",
          MDA: " ",
          MCO: " ",
          MNG: " ",
          MNE: " ",
          MSR: " ",
          MAR: " ",
          MOZ: " ",
          MMR: "Myanmar",
          NAM: " ",
          NRU: " ",
          NPL: " ",
          NLD: " ",
          ANT: " ",
          NCL: " ",
          NZL: "New Zealand",
          NIC: " ",
          NER: " ",
          NGA: " ",
          NIU: " ",
          NFK: " ",
          PRK: "North Korea",
          MNP: " ",
          NOR: " ",
          OMN: " ",
          PAK: " ",
          PLW: " ",
          PSE: " ",
          PAN: " ",
          PNG: "Papua New Guinea",
          PRY: " ",
          PER: " ",
          PHL: "Philippines",
          PCN: " ",
          POL: " ",
          PRT: " ",
          PRI: " ",
          QAT: " ",
          COG: " ",
          REU: " ",
          ROU: " ",
          RUS: " ",
          RWA: " ",
          BLM: " ",
          SHN: " ",
          KNA: " ",
          LCA: " ",
          MAF: " ",
          SPM: " ",
          VCT: " ",
          WSM: " ",
          SMR: " ",
          STP: " ",
          SAU: " ",
          SEN: " ",
          SRB: " ",
          SCG: " ",
          SYC: " ",
          SLE: " ",
          SGP: "Singapore",
          SXM: " ",
          SVK: " ",
          SVN: " ",
          SLB: " ",
          SOM: " ",
          ZAF: " ",
          SGS: " ",
          KOR: "South Korea",
          SSD: " ",
          ESP: " ",
          LKA: " ",
          SDN: " ",
          SUR: " ",
          SJM: " ",
          SWZ: " ",
          SWE: " ",
          CHE: " ",
          SYR: " ",
          TWN: "Taiwan",
          TJK: " ",
          TZA: " ",
          THA: "Thailand",
          TGO: " ",
          TKL: " ",
          TON: " ",
          TTO: " ",
          TUN: " ",
          TUR: " ",
          TKM: " ",
          TCA: " ",
          TUV: " ",
          VIR: " ",
          UGA: " ",
          UKR: " ",
          ARE: " ",
          GBR: " ",
          USA: " ",
          UMI: " ",
          URY: " ",
          UZB: " ",
          VUT: " ",
          VAT: " ",
          VEN: " ",
          VNM: "Vietnam",
          WLF: " ",
          ESH: " ",
          YEM: " ",
          ZMB: " ",
          ZWE: " "
        }
      })
    </script>
  </body>
</html>